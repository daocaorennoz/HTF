# Machine Learning Techniques for HFT using the limit order book data

[TOc]

## High Frequency Trade(HFT)

### HFT的定义

HFT全称为High Frequency Trade，是利用高速计算机进行编程和自动交易，使其达到毫秒甚至微秒的交易速度，并自动对行情价格序列进行判断来下单，从而远超普通计算机和人工交易员的交易速度，借此从极为短暂的市场变化中寻求获利。

### HFT的特征

- 高速且复杂的指令操作程序及极低的延迟

    简单而言就是将算法固化到计算机程序中去，利用计算机的速度优势，得到先发优势。

- 持仓时间短，交易次数多

    需要不断的买入卖出来实现小额套利收益的积累。报价流的微笑变化会触发大量开平仓信号，一旦监测到可套利信息，计算机程序会自动执行买卖指令，建立头寸，然后在交易完成之后平掉头寸。整个过程历时非常短，对于某只股票，高频交易者会在一天内交易数次，持仓时间从数秒到数小时不等。

- 批量挂单撤单

    高频交易通常会出现大量不被执行的订单。这种订单实际上是被用来探测市面上其他投资者的报价信息，以便后续执行订单或者取消订单，取得更加有利的操作。因此，高平订单中订单的额成交并非真正的报价，指令的提交很可能会被快速的撤销。

- 日内开平仓

    高频交易为了避免隔夜持仓成本和规避隔夜持仓带来的风险，会在当天收盘前平掉所有仓位。隔夜持仓成本是指隔夜持有保证金的头寸。
    所以对于高频交易者而言，开始交易时间一般为开盘之后的半小时，结束交易开始平仓时间一般为收盘前半小时。更加具体而言，在一天的交易数据中，前半个小时的数据会受到隔夜信息的影响，而体现在数据中的只有开盘价，所以很难将其利用起来，而收盘前半个小时为开平仓阶段，均属于异常时间段，所以我们在后续选择数据构造数据集的时候，摒弃了这一时间段，而选择了9：:30~14：30时间段内的数据作为训练数据。

### HFT的投资策略

- 被动做市交易策略

    做市商制度是一种市场交易制度，由具备一定实力和信誉的法人作为做市商，不断地向投资者提供买卖价格，并按照其提供的价格接受投资者的买卖要求，以其自有资金和证券与投资者进行交易，从而为市场提供及时性和流动性。
    做市商在为市场提供流动性需求的同时，做市商可以从证券的买卖差价中获得盈利。但单笔盈利微笑，该策略依赖于高频率的交易累积盈余。实际上如果没有差价可供盈利，做市商也会因为给市场带来了流动性而从交易所获得佣金回扣。

    举例：

        某机构交易者的买单心理交易价位为10.01~10.03，但是会将大额买单拆分多个买单，
        且每个买单大小均在100~500股之间，前两个买单均已10美元的价格成交，这时做市商的
        算法系统很可能监测到市面上会存在大量10美元订单的需求，所以做市商以10.01的价格
        买入股票，随机转变交易方向，以10.01或更高的价格挂单卖出，因为市面上10美元的股
        票已经售完，机构投资者很可能是这批股票的买入方。做市商获得价差方面的盈利，
        即使没有获得价差的盈利，也会从交易所的回扣佣金中获利。

- 统计套利策略

指通过对两种证券或者两个组合的价格关系或者其他特征关系中进行套利交易的策略。
如果两种证券或者组合的价格是由相同的或相近的驱动因素所驱动，在这种驱动关系没有发生变化的情况下，假如证券或组合的价格关系出现短暂的偏离，可以反向建立头寸，等待关系回归常态。

可以建立统计套利策略的证券对或者组合对有：

    - 衍生品及其标的证券
    - ETF及其成分股
    - 高度相关的股票或期货（配对交易）
    - 资源类公司及相应资源的期货等

- 订单流交易、市场微观结构交易

    利用order book的信息来辅助判断，将order book上的信息作为还未发生的交易信息，从中尝试挖掘蕴含的信息，并尝试预测对未来一段时间内的成交价格的影响。

    这种方法的前提是我们假设order book与成交明细之前尊在某种规律，可以统计观察订单中的（小单、中单、大单、市场单、限价单、撤单和新到单）在时间轴上的频率、频数以及各种衍生出的统计信息。

### 高频交易和量化交易、自动交易之间的区别

高频交易是指从那些人们无法利用的、即为短暂的市场变化中寻求获利的计算机化交易，例如某种证券买入价和卖出价差价的微小变化，或者某只股票在不同交易所之间的微小价差（这是针对非中国的股票交易市场而言）

而量化交易的核心是策略分析，通过对历史数据、实时数据的分析，选择最佳的股票交易的品种，以及交易（买进、卖出）的时间点，就是传统的择股交易与择时交易。

自动交易起源于美国1975年出现的‘股票组合转让与交易’，随着技术的发展和计算机系统的应用，投资经理、经纪人可以实现股票组合的一次性买卖交易；自动交易软件就是让计算机按照用户事先设定好的条件自动交易，音轨结果取决于用户的交易计划设计的好快。

## Order book的形式以及意义

### Order book的形式

字段名 | 类型 | 描述说明
-|-|-|
MsgHead|MsgType=20403
MsgID |Uint64 |消息ID
SecID |Char[16] |交易所证券代码
Market |Uint16 |市场
OrigTime |Uint64 |数据生成时间（间隔不定）
TradeStatus |Byte |见字典
PreClosePrice |Uint32 |昨收盘价
OpenPrice |Uint32 |开盘价
HighPrice |Uint32 |最高价
LowPrice |Uint32 |最低价
LastPrice |Uint32 |最新价（最新撮合价格）
AskPrice |Uint32[10] |申卖价（list）
AskVol |Uint64[10] |申卖量（list）
BidPrice |Uint32[10] |申买价（list）
BidVol |Uint64[10] |申买量（list）
TotalTradeNum |Uint32 |成交笔数
TotalTradeVol |Uint64| 成交总量
TotalTradeValue| Uint64 |成交总金额（单位：元）
TotalBidVol|Uint64|委托买入总量
TotalAskVo|Uint64|委托卖出总量
WeightAvgBidPrice |Uint32 |加权平均委托买入价
WeightAvgAskPrice|Uint32|加权平均委托卖出价
IOPV|Uint32|IOPV净值估值
YieldToMaturity|Int32 |到期收益率
HighLimited|Uint32|涨停价
LowLimited|Uint32|跌停价

由表中可以得出，order book中含有不同level的ask、bid的交易价格和交易量以及其他反应当时市价行情的数据包括最新价，当前成交总量，当前成交笔数等信息。

### order book的意义

随着交易市场电子化的加深，更多高质量的数据被更加容易的获得，用来描述市场参与者在最佳时机的决策和交互。而动态order book的复杂性已经成为所有市场参与者和监管者为了增加市场交易的透明性和有效性而必须面对的问题。

通过对order book的建模与分析，可以在更大的时间范围内洞察市场的变动，具体体现在价格的变动上，因为价格的形成或者变动的过程是从订单级别开始的。

更加准确的说，我们假设针对order book的模型和Queue-Reactive model是相似的。我们限制在ask-bid价格内成交，有限制的订单一直以一定的强度进入系统，当一个队列被消耗尽的时候，他将以确定的准则和可能的价格异动来再次被生成。order book 在ask 和bid 两端的不平衡性会对不同的成交概率产生影响。

主要用两种主流的方法来对order book进行分析：

- 基于一般的均衡模型，包括经济学模型，这种方法基于将市场行为视为是例行的代理人在市场筛选过程中所做的最优决策的影响的前提。
- 基于统计学模型，将order book视为数学上的随机过程，这种模型重点是基于现有的市场数据来再建真实市场中重要的显著的特征，而不是关注代理人的行为和交互。

## Machine Learning 利用 order book 在HFT中的应用

可以按照不同的建模思路将其划分成三种不同的类别。

如果将任务目标视为预测股票的涨、跌和不变，那么任务就变成了多分类任务，主要用到的是分类模型。
如果将任务目标视为预测股票的具体价格，那么任务就变成了回归任务，主要用到的是回归模型。

不同的建模思路会导致对数据集中label的处理方式不一样。
分类任务中按照下一个单位时间内的价格的涨跌幅度，按照具体的区间划分成不同的类别。而回归任务，则不会对价格做变换，但实际上分类和回归任务之间是可以相互转换的。

### 分类任务

#### label 的处理

- 按照偏差来划分：$mid\_price = \frac{1}{2}(P_i^{ask} + P_i^{bid})$
    如果$\hat{p_i}-mid\_price >= k*tick\_price$，label = up，其中也可以细分为up 和strong up；
    如果$\hat{p_i}-mid\_price <= -k*tick\_price$,label = down,其中也可以细分为down和strong down;
    如果落在两者中间，则认为其是稳定的，label = stationary
- 按照偏差的比例来划分：$l_i^{(j)} = \frac{\frac{1}{k}\sum_{j=i+1}^{i+k}m_j - m_i}{m_i}$
    按照论文中的划分，
    $l_i^{j}> 0.002$, label = up;
    $-0.00199<l_i^{j}<0.000199$,label = stationary;
    $-0.002> l_i^{j}$,label = down.

#### 模型应用

- LR

    Logistics Regression，全称是逻辑斯特回归，是一种二分类模型，将线性模型的结果经过一个指数对数的变换，将结果压缩至概率范围内，使得结果不仅预测出类别，还得到近似概率的预测。
    当该模型扩展至多分类任务的时候，可以使用one-vs-all或者one-vs-one的策略，也可以使用softmax损失函数，而将其衍生至softmax回归模型。
    Zheng（2012）利用LR的方法来预测价格的变动。

- SVM

    Support Vector Machine，全称是支持向量机，是一种二分类模型；是定义在特征空间上的、间隔最大的线性分类器，但由于其支持核技巧，从而使它成为实质上的非线性分类器。
    当数据集线性可分的时候，我们可以通过硬间隔最大化，学习一个线性分类器，即线性可分支持向量机（也称为硬间隔支持向量机）；
    当数据集近似线性可分的时候，我们可以通过软间隔最大化，学习一个线性分类器，即线性支持向量机（也称为软间隔支持向量机）；
    当数据集线性不可分的时候，我们可以通过核技巧以及软间隔最大化，学习一个非线性分类器，即非线性支持向量机。
    当任务变成多分类任务的时候，主要有两种方法：

  - 直接法

        直接在目标函数上进行修改，将多个分类面参数求解合并到一个最优化问题中去，通过求解该问题一次实现多分类效果。虽然该方法简单，但由于其计算复杂度很大，所以只适用于小型问题；
  - 间接法

    - 一对多法（one-verus-rest）
        训练时依次将某个类别的样本归为一类，其他剩余样本归为另一类，这样k个类别的样本就构造除了k个SVM，分类时将分类样本划分到具有最大分类函数值的那类。
        假设有k个类别要划分，训练时便依次把某个类别归为一类，其他样本归为另一类，使整个数据集二类化，然后依次训练k个分类器，在接受新样本的时候，分别送进k个分类器，然后得到k个间隔，选取间隔最大的那个类别作为样本的类别。
    - 一对一法（one-verus-one）
        做法是在任意两个类别之间训练一个SVM分类器，因此k个类别就需要$\frac{k(k-1)}{2}$个分类器，当接收一个未知样本的时候，得票最多的类别即为该未知样本的预测类别。
    kerchevak(2014),James（2015）利用SVM模型，采用一对多的方法来对价格变动进行了研究。

- RF

    Random Forest，全称是随机森林，基于集成学习的思想，使用决策树作为基学习器，构建bagging的集成模型来分类。在bagging自助采样法的基础上，即在样本随机的基础上进一步在决策树的训练过程中引入了随机属性的选择，有效地提升了模型的泛化能力。

    James(2015)利用RF来和SVM做对比实验。

- NN

    Neural nework，利用神经网络强大的拟合能力，接受特征输入，输出分类，是一个端到端的模型。其中单层的神经网络只能拟合线性的函数，而多层神经网络可以拟合任意函数。对于k个类别的分类问题，神经网络的本质是把原问题分解为一类对其他类的（one-verus-all）的二分类问题，最终输出k维的one-hot表示向量，来代表最终的类别。
    Galeshchuk(2016)使用了含有三层隐藏层的多层全连接前向网络对来尝试预测价格变动。

### 回归任务

#### label的处理

label本身就是个数值型变量，所以不需要进行处理。

- Linear Model

    线性模型是从输入的特征到输出的目标之间找到一个线性映射，针对特征的维度，分为一元线性回归和多元线性回归。然后利用给定的损失函数进行参数的学习。

    在线性回归的基础上，对参数做一个约束，如果添加的是对参数的L1正则化，那么线性模型就转变为Lasso Regression；如果添加的是L2正则化，则线性模型转变为Ridge Regression。

    Liu（2015）采用了一个多元线性回归的模型来解释股票短时间内的价格波动以及后续利用最优价差进行股票情况的预测。
    Detollenaere（2017）利用Lasso回归来进行降维，接着将挑选出的维度特征送进LR。
    Adamantios（2018）利用Ridge回归来进行baseline的构建。

    Panayi（2016）利用类似于高斯模型的广义线性模型来对TED（threshold exceedance duration，用来度量流动性补偿的时间长度）进行预测。

- RBF（Radis Basis Function）

    径向基模型是三层前向神经网络，单隐层的神经网络结构，且隐层激活函数为高斯函数，输出层是隐层输出的线性组合。用RBF作为隐单元的“基”构成隐含层空间，这样就可以将输入矢量直接映射到隐空间，而不需要通过权连接。当RBF的中心点确定以后，这种映射关系也就确定了。而隐含层空间到输出空间的映射是线性的，即网络的输出是隐单元输出的线性加权和。一般可以使用k-means算法首先确定出中心点，然后再进行RBF其他参数的确定。
    Adamatios（2018）利用RBF进行baseline的构建。

- SVR（support vector regression）

    支持向量回归模型，是支持向量机的扩展，传统回归模型当且仅当f(x)完全等于y的时候，才认为预测正确，而SVR认为只要f(x)与y偏离程度不要太大，就可以认为预测正确。
    Milidiu（2010）利用这种SVR和partial least squares（PLS）结合的方法预测了圣保罗交易所的10支股票的情况。

- 时序分析模型  
    时间序列分析就是使用统计的手段对这个序列的过去进行分析，以此对该变量的变化特性建模、并对未来进行预测。
  
  - RNN
    Recurrent neural network，循环神经网络，是一种特殊的神经网络，不仅考虑了前一时刻的输入，而且赋予了网络对前面的内容的一种记忆功能，即一个序列当且的输出与前面的输出也相关，具体表现形式为，网络对前面的信息进行记忆，并应用于当前的输出的计算中。背后的本质思想是利用顺序的信息。
    Dixon（2016）利用RNN使用超高频的数据实现了对T-bouns和ES500期货的价格预测。

  - ARMA
    Autoregressive moving average model，自回归滑动平均模型，将一个p阶的自回归模型和q阶的滑动平均模型结合起来，便得到了阶数为(p,q)，将AR和MA优势互补的线性模型。使用历史数据对未来进行预测，捕捉市场参与者的有效性，并对噪声建模，接受是市场突发信息的影响，形成最终的预测结果。
    Cenesizoglu（2014）利用一个自回归模型，用订单簿的状态来预测股票价格的走势。

  - ARIMA
    Autoregressive Integrated Moving Average model，差分自回归滑动平均问题，将非平稳时间序列，转化为，平稳时间序列；然后将因变量仅对它的滞后值以及随机误差项的现值和滞后值进行回归所建立的模型
    Liu（2005）使用一个ARIMA和SVM的混合模型来进行股票价格的预测。

### 其他统计学方法（数值方法）

- Chan（2017）使用独立混合poisson过程来对订单流进行建模
- Nicolas（2019）使用一维维纳空间来对订单簿进行建模

## 任务流程

### 数据集的构建

- 选择原始数据集
  
  选择10天的交易记录，将前九天处理成训练集，最后一天处理成测试集。

- 按照预定的学习目标生成label

- 数据标准化（处理缺失值和长尾分布）

### 评价指标

- 分类指标
  准确率
  $$
        Accuracy = \frac{TP + TN}{TP + TN + FP + FN}
  $$
  精度
  $$
        Precision = \frac{TP}{TP + FP}
  $$
  召回
  $$
        Recall = \frac{TP}{TP + FN}
  $$
  F1
  $$
        F1 = 2 \times \frac{Precision \times Recall}{Prescision + Recall}
  $$

- 回归指标

    Mean Square Error(均方误差)
    $$
    Loss = \frac{1}{N}\Sigma_{i=1}^N(y_i-\hat{y_i})^2
    $$

### 特征工程

将特征分为三种：basic、time-sensitive、和time-insensitive

- basic
  $\forall i \in  N^+[1,10]$
  - $P_i^{ask}$
  - $P_i^{bid}$
  - $V_i^{ask}$
  - $V_i^{bid}$
- time-insensitive
  - Spread:$P_i^{ask}-P_i^{bid}$
  - mid-price:$\frac{P_i^{ask}-P_i^{bid}}{2}$
  - $\frac{1}{n}\sum_{i=1}^nP_i^{ask}$
  - $\frac{1}{n}\sum_{i=1}^nP_i^{bid}$
  - $\frac{1}{n}\sum_{i=1}^nV_i^{ask}$
  - $\frac{1}{n}\sum_{i=1}^nV_i^{bid}$
  - $\sum_{i=1}^n(V_i^{ask}-V_i^{bid})$
  - $\sum_{i=1}^n(P_i^{ask}-P_i^{bid})$
  - 委比 = （委买五档手数之和-委卖五档手数之和）/（委买五档手数之和+委卖五档手数之和）
  - 成交均价 = 成交总金额/成交总量
  - 现手 = 最近一笔成交量
  - 涨跌金额 = 当前金额 - 昨日收盘价格
  - 涨跌幅度 = 涨跌金额 / 昨日收盘价格
  - 振幅 = 当前最高价 - 最低价 / 昨日收盘价格
  - 换手率 = （当日总手数*100） / 流通股数
  - 
- time-sensitive
  $\forall i \in  N^+[1,10]$
  - $dP_i^{ask}/{dt}$
  - $dP_i^{bid}/{dt}$
  - $dV_i^{ask}/{dt}$
  - $dV_i^{bid}/{dt}$
  - 成交总量的变化率
  - 成交笔数的变化率
  - 
  
### Baseline

- SVM
- MLP
- LR

### 拟采用方法

- 按照30min来划分，将10：00-11：00，1：00-2：30，划分为5个阶段，采取增量学习的方式，用5个模型来分别学习10:00-10:30,10:00-11:00,10:00-1:30,10:00-2:00,10:00-2:30
- 对不同的时间后延，训练不同的模型，以预测3s，6s，9s，后的股票价格走势。

### 展望

### 想法

我们不认为这个序列具有一定的规律性，因为这是日内交易，所以我们将时间序列特征转换成各个特征关于时间的变化，所以我们求出关于时间的导数
